<% ROOTURL = "#{request.env['rack.url_scheme']}://#{request.env['HTTP_HOST']}" %>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<link href="<%= url('/header.css') %>" rel="stylesheet" type="text/css" />
<div class="block api_connection_info" style="display:none;">
  <label><span>Username:</span><input type="text" class="user_name" name="api_username" value="rahman-11" placeholder="username"></label>
  <label><span>Path:</span><input type="text" class="store_path" name="api_path" value="https://store-auiautt3.mybigcommerce.com/api/v2/" placeholder="store_url"></label>
  <label><span>Token:</span><input type="text" class="token" name="api_token" value="ab2290273590c54591c60ea363b98cc723d361b7" placeholder="api_token"></label>
</div>
<p><button type="button" class="small right showbutton" data-showelement=".api_connection_info">Edit api connection info</button></p>
<%
   @demo_functions = {
        'get_products' => {
          'default_input' => {
                  'parameters' => {
                         "api_username"=> "saran-sample",
                         "api_token"=> "b96bb98aae600a4cc22a9be342dabbf8dbf0997b",
                         "api_path"=> "https://store-m3l3la.mybigcommerce.com/api/v2/",
                         "min_date_modified" => "2015-06-08T04:51:54+00:00"
                  },
                  'products' => [{
                         "min_date_modified" => "2015-06-08T04:51:54+00:00"
                  }]
          },
          'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/products#list-products'
        },

        'get_orders' =>{
          'default_input' => {
                  'orders' => [{
                          'customer_id' => '3'
                  }]
          },
          'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/orders#list-orders'
        },
        'get_customers' =>{
          'default_input' => {
                  'customers' => [{
                          'customer_group_id' => '0',
                  }]
          },
          'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/customers#list-customers'
        },

        'get_shipments' => {
          'default_input' => {
                  'shipments' =>{
                          'limit' => '100',

                  }
          },
         'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/orders/shipments#list-shipments'
        },
        'get_shipment' => {
          'default_input' => {
                  'request_id' => '',
                  'parameters' =>{
                          'limit' => '100'
                  },
                  'order_id' => 101,
                  'shipment_id' => 4,
          },
         'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/orders/shipments#get-shipment'
        },

        'add_product' => {
          'default_input' =>{
                  'parameters' => {
                          "api_username"=> "saran-sample",
                          "api_token"=> "b96bb98aae600a4cc22a9be342dabbf8dbf0997b",
                          "api_path"=> "https://store-m3l3la.mybigcommerce.com/api/v2/",
                          "min_date_modified" => "2015-06-08T04:51:54+00:00"
                  },
                  'product' => [{
                          "name"=> "sd",
                          "sku"=> "sd",
                          "description"=> "This timeless fashion staple will never go out of style!",
                          "price"=> "1429.99",
                          "categories"=> [
                              14
                          ],
                          "type"=> "physical",
                          "availability" => "available",
                          "weight" => "0.5"
                         }],
                  },
          'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/products#create-product'
        },

        'add_order' => {
          'default_input' => {
                  'request_id' => '',
                  'parameters' => {
                          'limit' => '100',
                  },
                  'order' => {
                          "products"=>[{
                                  "product_id"=> '75',
                                  "quantity"=>2,
                                  "price_inc_tax"=> 10.0,
                                  "price_ex_tax"=> 10
                          }],
                          'billing_address' => {
                          'first_name' => 'Some',
                          'last_name' => 'Person',
                          'company' => '',
                          'street_1' => '123 Some St',
                          'street_2' => '',
                          'city' => '',
                          'state' => 'District of Columbia',
                          'zip' => '78757',
                          'country' => 'United States',
                          'country_iso2' => 'US',
                          'phone' => '',
                          'email' => 'some.person@example.com',
                          },

                  },
          },
         'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/orders#create-order'
        },

        'add_customer' => {
          'default_input' => {
                  # 'request_id' => '',
                  # 'parameters' => {
                  #         'limit' => '100',
                  # },
                  'customer' => [{
                          'first_name' => 'Some',
                          'last_name' => 'Person',
                          # 'email' => 'some.person'.rand().'@example.com',
                  }],
          },
          'doc_link' => 'https://developer.bigcommerce.com/api/stores/v2/orders#create-order'
        },
  }
%>

<div class="block">
  <dl>
   <%@demo_functions.each do |key,value| %>

    <dt><%= key %></dt>
    <dd>
      <p><a href=<%= value['doc_link']  %> target="_blank"> <%= 'Supported Parameters' %></a></p>
      <form class="one_column" action="<%= ROOTURL+'/'+ key%>">
        <fieldset>
          <legend>&rsaquo; <%= key %> &rsaquo; <em>request</em></legend>
          <textarea><%= JSON.pretty_generate(value['default_input']) %></textarea>
          <button type="submit">Send</button>
        </fieldset>
        <fieldset style="display:none;">
          <legend>&rsaquo; <%= key %> &rsaquo; <em>response</em><span class="response_status"></span></legend>
          <div class="response"><textarea></textarea></div>
          <button type="button" class="response_clear">Clear</button>
        </fieldset>
      </form>
    </dd>
   <%end %>
  </dl>
</div>

<script type="text/javascript">
    $('form').on('submit',function(event){
        event.preventDefault();
        var user_name = $(".user_name").val();
        var store_url = $(".store_path").val();
        var token = $(".token").val();
        var $form = $(this);
        var $button = $form.find('button[type=submit]');
        if(!$button.is(':disabled'))
            if (user_name === "" || store_url === "" || token === "" ){
                alert("Check user_name,Store_url and token ")
            }else{
                WombatTestFront.request($form);
            }
    });

    $('.response_clear').on('click',function(){
        $(this).parent().fadeOut(function(){
            $(this).parents('.two_columns').attr('class','one_column');
        });
    });

    $('button[type=submit]').after('<div class="loading-spinner" style="display:none;"></div>');

    var WombatTestFront = {
        request: function($form){
            // useful elements
            var $response = $form.find('.response');
            var $response_status = $form.find('.response_status');

            // button reflects request status...
            var $button = $form.find('button[type=submit]');
            var button_text = $button.text();
            $button.text('Loading...');
            $button.next('.loading-spinner').fadeIn();
            $button.prop('disabled', true);

            // get data to send with request
            var request_data = $form.find('fieldset:first textarea').val();
            var request_object = [];
            var request_input;
            // parse input JSON
            try { request_object = $.parseJSON(request_data);

            request_object.api_username = encodeURIComponent($('.api_connection_info input[name=api_username]').val());
            request_object.api_path = decodeURIComponent($('.api_connection_info input[name=api_path]').val());
            request_object.api_token = encodeURIComponent($('.api_connection_info input[name=api_token]').val());
            console.log(request_object.api_path);
                request_input = JSON.stringify(request_object,null,null);}
            catch (e) { }

            if(!request_object) {

                $response_status.addClass('response_error');
                $response.find('textarea').val('Input JSON is invalid.');

                // update form to reflect complete request
                $button.text(button_text);
                $button.prop('disabled', false);
                $button.next('.loading-spinner').fadeOut();

                $response_status.html('error');
                $response_status.attr('title','Request URL:\n'+$form.attr('action'));

                $response.parents('.one_column').attr('class','two_columns');
                $response.parent().fadeIn();

            } else { // request object parsed
                // make request
//                request_object.parameters.api_username = encodeURIComponent($('.api_connection_info input[name=api_username]').val());
//                request_object.parameters.api_path = encodeURIComponent($('.api_connection_info input[name=api_path]').val());
//                request_object.parameters.api_token = encodeURIComponent($('.api_connection_info input[name=api_token]').val());

                $response.find('textarea').val('Loading...');
                $response_status.attr('class','response_status').html('loading');

                $.ajax({
                    type: "POST",
                    url: $form.attr('action'),
                    data: request_input,
                    error: function(jqXHR,textStatus,errorThrown){
                        $response_status.addClass('response_error');
                        $response.find('textarea').val(errorThrown);
                    },
                    success: function(data,textStatus,jqXHR) {
                        if(typeof data === 'object')
                            data = JSON.stringify(data,null,4);

                        $response_status.addClass('response_success');
                        $response.find('textarea').val(data);
                    },
                    complete: function(jqXHR, textStatus) {
                        // update form to reflect complete request
                        $button.text(button_text);
                        $button.prop('disabled', false);
                        $button.next('.loading-spinner').fadeOut();

                        $response_status.html(textStatus);
                        $response_status.attr('title','Request URL:\n'+$form.attr('action'));

                        $response.parents('.one_column').attr('class','two_columns');
                        $response.parent().fadeIn();
                    }
                });
            }
        }
    };

    $('.showbutton').on('click',function(){
        var data_show_ele = $(this).attr('data-showelement');
        $(data_show_ele).slideDown();
        $(this).parent().fadeOut();
        console.log( this.value );
    });
</script>